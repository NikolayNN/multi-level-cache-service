# Multi-Level Cache Service

Multi-Level Cache Service - это экспериментальное приложение на Go, демонстрирующее работу многоуровневого кэша. Сервис позволяет прозрачно использовать несколько слоёв хранения данных и может интегрироваться с клиентами на Spring через REST API.

## Содержание
- [Структура репозитория](#структура-репозитория)
- [Архитектура](#архитектура)
- [Основные операции](#основные-операции)
- [REST API](#rest-api)
- [Конфигурация](#конфигурация)
- [Сборка](#сборка)
- [Запуск тестов](#запуск-тестов)

## Структура репозитория
- `cmd/` — точка входа приложения. В папке `server` находится `main.go`.
- `api/` — DTO и мапперы для обмена данными между слоями.
- `internal/`
  - `cache/` — логика многослойного кэша и провайдеры.
  - `integration/` — получение данных из внешних сервисов при промахах.
  - `manager/` — высокоуровневый менеджер, упрощающий работу с кэшем.
- `configs/` — пример конфигурации `cache.yml`.
- `tests/` — интеграционные тесты (например, для RocksDB клиента).

## Архитектура
Система кэширования построена по принципу каскада с несколькими уровнями хранения. Каждый уровень может использовать собственный провайдер:

- **L0 (Ristretto)** — самый быстрый in-memory кэш, предназначенный для «горячих» данных.
- **L1 (Redis)** — быстрый кэш в оперативной памяти. Используется для хранения часто запрашиваемых значений.
- **L2 (RocksDB)** — локальный дисковый кэш. Позволяет переживать перезапуски сервиса.
- **L3 (API Gateway)** — внешний источник данных, из которого запрашиваются значения при промахах во всех слоях.

Клиент взаимодействует с кэшем как с единой системой. Если значение найдено на одном из уровней, оно возвращается и сохраняется в более высоких слоях (каскадное обновление).

## Основные операции
### Получение значения (GET)
1. Формируется ключ `<cache>:<key>` и выполняется поиск в L0.
2. При промахе запрос идёт в L1, далее в L2.
3. Если значение найдено на более медленном уровне, оно копируется в вышестоящие уровни.
4. При отсутствии значения во всех слоях выполняется запрос к L3 (внешний API).

### Сохранение значения (PUT)
Данные записываются последовательно на все активные уровни кэша. TTL может задаваться индивидуально для каждого уровня.

### Удаление значения (DELETE)
Значение удаляется из всех уровней. При необходимости отправляется запрос во внешний API.

### Пакетные операции (BATCH)
Сервис поддерживает пакетные GET/PUT/DELETE для оптимизации сетевых вызовов. Каждый элемент пакета обрабатывается так же, как одиночный запрос.

## REST API
Ниже приведены основные эндпоинты сервиса.

### Получение значения
```
GET /api/cache/{cacheName}/{key}
```
Возвращает значение из кэша или `404`, если оно отсутствует.

### Сохранение значения
```
PUT /api/cache/{cacheName}/{key}
```
В теле запроса передаётся JSON со значением. Данные записываются во все уровни кэша.

### Удаление значения
```
DELETE /api/cache/{cacheName}/{key}
```
Удаляет данные из всех уровней.

### Пакетные запросы
```
POST /api/cache/batch/get
POST /api/cache/batch/put
POST /api/cache/batch/delete
```
Формат тела запроса содержит массив объектов с полями `c` (cacheName) и `k` (key). Для PUT также передаётся `v` (value).

## Конфигурация
Конфигурационный файл `configs/cache.yml` описывает провайдеры, порядок слоёв и параметры отдельных кэшей. Пример фрагмента:

```yaml
providers:
  - name: "ristretto-l0"
    type: "ristretto"
    numCounters: 1_000_000
    bufferItems: 64
    maxCost: 64MiB
    defaultTTL: 15s

  - name: "redis-l1"
    type: "redis"
    host: localhost
    port: 6370
    password: "12345"
    db: 0
    poolSize: 10
    timeout: 5s

  - name: "rocksdb-l2"
    type: "rocksdb"
    path: "/path"
    createIfMissing: true
    maxOpenFiles: 100
    blockSize: 64MiB
    blockCache: 64MiB
    writeBufferSize: 64MiB

layers:
  - name: "ristretto-l0"
    mode: "enabled"
  - name: "redis-l1"
    mode: "enabled"
  - name: "rocksdb-l2"
    mode: "enabled"

caches:
  - name: user
    prefix: "u"
    layers:
      - enabled: true
        ttl: 30s
      - enabled: true
        ttl: 10m
      - enabled: true
        ttl: 6h
    Api:
      enabled: true
      getBatch:
        url: "localhost:8080/user"
        prop: "id"
```

Конфигурация валидируется при запуске приложения (см. пакет `internal/cache/config`).

## Сборка
Для сборки требуется Go 1.24+. Пример последовательности действий:

```bash
go mod download

go build ./cmd/server
```

## Запуск тестов

```bash
go test ./...
```

## Метрики

Сервис экспортирует метрики в формате Prometheus. После запуска приложения они
доступны по HTTP на пути `/metrics` (по умолчанию порт `8080`). Достаточно
перейти в браузере по ссылке:

```
http://localhost:8080/metrics
```

Для сбора статистики можно настроить Prometheus, добавив в конфигурацию
следующий scrape target:

```yaml
scrape_configs:
  - job_name: cache-service
    static_configs:
      - targets: ['localhost:8080']

